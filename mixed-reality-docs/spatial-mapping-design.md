---
title: 空間マッピングのデザイン
description: HoloLens 内で空間マッピングを効果的に使用するには、多くの要因を慎重に検討する必要があります。
author: cre8ivepark
ms.author: dongpark
ms.date: 03/21/2018
ms.topic: article
keywords: Windows Mixed Reality、設計、空間マッピング、HoloLens、surface 再構築、メッシュ
ms.openlocfilehash: 451213a79e1d482d64725ce750065611830beec3
ms.sourcegitcommit: 17f86fed532d7a4e91bd95baca05930c4a5c68c5
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/11/2019
ms.locfileid: "66829957"
---
# <a name="spatial-mapping-design"></a>空間マッピングのデザイン

HoloLens 内で空間マッピングを効果的に使用するには、多くの要因を慎重に検討する必要があります。

## <a name="device-support"></a>デバイスのサポート

<table>
    <colgroup>
    <col width="33%" />
    <col width="33%" />
    <col width="33%" />
    </colgroup>
    <tr>
        <td><strong>機能</strong></td>
        <td><a href="hololens-hardware-details.md"><strong>HoloLens</strong></a></td>
        <td><a href="immersive-headset-hardware-details.md"><strong>イマーシブ ヘッドセット</strong></a></td>
    </tr>
     <tr>
        <td>空間マッピングのデザイン</td>
        <td>✔️</td>
        <td>❌</td>
    </tr>
</table>

## <a name="why-is-spatial-mapping-important"></a>空間マッピングが重要な理由

空間マッピングを使用すると、オブジェクトを実際のサーフェイスに配置できます。 これは、オブジェクトをユーザーの世界に固定し、実際の深さの手掛かりを活用するのに役立ちます。他のホログラムや実際のオブジェクトに基づいてホログラムを Occluding することで、これらのホログラムが実際に空間にあることをユーザーに納得させることができます。 領域内のホログラムまたはユーザーとの移動は実際とは言えません。 可能な場合は、アイテムを快適に配置します。

ホログラムを配置または移動するときにサーフェイスを視覚化します (単純な射影グリッドを使用します)。 これにより、ユーザーがホログラムを最適に配置できる場所を知ることができます。また、ホログラムを配置しようとしている場所がまだマップされていない場合は、ユーザーが表示されます。 角度が非常に多い場合は、ユーザーに "ビルボード項目" を設定できます。

## <a name="what-influences-spatial-mapping-quality"></a>空間マッピングの品質に影響を与えるもの

最適なユーザーエクスペリエンスを提供するために、HoloLens によって収集される空間マッピングデータの品質に影響する要因を理解することが重要です。

空間マッピングデータのエラーは、次の3つのカテゴリのいずれかに分類されます。
* **穴**:空間マッピングデータに実際のサーフェイスがありません。
* **Hallucinations**:サーフェイスは、実際の環境に存在しない空間マッピングデータに存在します。
* **バイアス**:空間マッピングデータ内のサーフェイスは、実際のサーフェイスに固定されていて、プッシュまたはプルされます。

これらのエラーの頻度と重大度に影響する要因がいくつかあります。

* **ユーザーの動き**
   * ユーザーが環境を移動する方法によって環境がどのようにスキャンされるかが決まります。そのため、ユーザーは適切なスキャンを実行するためにガイダンスを必要とする可能性があります。
   * スキャンに使用されるカメラは、70°の円錐内のデータを提供します。これは、最低0.8 メートルから、カメラからの最大3.1 メートル距離までの範囲です。 実際のサーフェイスは、このフィールドのビュー内でのみスキャンされます。 これらの値は将来のバージョンで変更される可能性があることに注意してください。
   * ユーザーがオブジェクトの3.1 メートル以内に取得されない場合、そのユーザーはスキャンされません。
   * ユーザーがオブジェクトを表示している距離が0.8 メートル未満の場合は、スキャンされません (これにより、ユーザーの手がスキャンされることはありません)。
   * ユーザーが上向きに見えない場合 (通常は通常)、切り上げはスキャンされない可能性があります。
   * ユーザーが家具や壁を見られない場合は、その occluded オブジェクトはスキャンされません。
   * サーフェイスは、浅い角度ではなくヘッドオンに表示されると、より高い品質でスキャンされる傾向があります。
   * HoloLens のヘッドトラッキングシステムが一時的に失敗した場合 (ユーザーのすばやい動き、照明が featureless、カメラがカバーされていないことが原因で発生する可能性があります)、空間マッピングデータでエラーが発生する可能性があります。 このようなエラーは、ユーザーが引き続き環境を移動してスキャンするときに、時間の経過と共に修正されます。

* **表面素材**
   * 実際のサーフェイスで見つかった素材は大きく異なります。 これらは赤外線光の反射方法に影響するため、空間マッピングデータの品質に影響します。
   * 暗い表面は、カメラに近づくまでスキャンしないことがあります。
   * 表面によっては、どのような距離からもスキャンできない光が少なすぎることがあります。そのため、表面の位置に穴のエラーが発生し、場合によってはサーフェイスの背後にあることもあります。
   * 特に光沢のある表面は、浅い角度から表示されているときではなく、ヘッドオン時にのみスキャンできます。
   * ミラーは、illusory によって真のスペースと表面の反射が生じるため、穴のエラーと hallucination の両方のエラーが発生する可能性があります。

* **シーンモーション**
   * 空間マッピングは、スタッフの移動やドアの開閉など、環境の変化に迅速に適応します。
   * ただし、空間マッピングは、スキャンに使用されるカメラから領域が明確に表示される場合にのみ、領域内の変更に適応できます。
   * このため、この適応が現実の背後で遅れる可能性があり、これにより、hallucination エラーが発生する可能性があります。
   * 例として、ユーザーが友人をスキャンし、友人が部屋から離れている間にそのようなことを止めます。 フレンドの ' ゴースト ' 表現 (hallucination エラー) は、ユーザーがその友人が立っている領域を再び表示して再スキャンするまで、空間マッピングデータ内で保持されます。

* **照明の干渉**
   * シーン内のアンビエント赤外線ライトは、ウィンドウが表示されるなど、スキャンに干渉する可能性があります。
   * 特に光沢のある表面は、隣接する表面のスキャンに干渉する可能性があります。光がずれていると、バイアスエラーが発生します。
   * 光をカメラに直接反射している光沢のある表面は、近接している空気 hallucinations を引き起こしたり、シーンの動きへの適応を遅らせたりすることによって、近くの領域に干渉する可能性があります。
   * 同じ部屋に2つの HoloLens デバイスが相互に干渉することはありませんが、5つを超える HoloLens デバイスが存在すると、干渉が発生する可能性があります。

これらのエラーの一部を回避または修正できる可能性があります。 ただし、空間マッピングデータにエラーがある場合でも、ユーザーが目標を達成できるように、アプリケーションを設計する必要があります。

## <a name="the-environment-scanning-experience"></a>環境のスキャンエクスペリエンス

HoloLens では、ユーザーが環境内のサーフェイスについて学習します。 時間の経過と共に、HoloLens は、監視されている環境のすべての部分のスキャンを構築します。 また、環境内の変更が確認されると、スキャンも更新されます。 このスキャンは、アプリの起動間に自動的に保持されます。

空間マッピングを使用する各アプリケーションでは、"スキャンエクスペリエンス" を提供することを検討する必要があります。アプリケーションが正常に機能するために必要なサーフェイスをスキャンするためにアプリケーションがユーザーに指示するプロセス。

![スキャンの例](images/sr-mixedworld-140429-8pm-00068-1000px.png)<br>
*スキャンの例*

このスキャンエクスペリエンスの性質は、アプリケーションのニーズによって大きく異なる場合がありますが、主に2つの原則として設計を行う必要があります。

まず、**ユーザーとの通信をクリア**します。 ユーザーは、アプリケーションの要件が満たされているかどうかを常に把握している必要があります。 これらが満たされていない場合は、その理由をユーザーにすぐに明確にする必要があります。また、適切な操作を行うための迅速な対応が必要になります。

また、**アプリケーションは、効率性と信頼性のバランスを取るように試み**ます。 **信頼性**を高めるために、アプリケーションでは、ユーザー時間を節約するために、空間マッピングデータを自動的に分析する必要があります。 信頼性を高めることができない場合は、アプリケーションでは、アプリケーションに必要な追加情報を迅速に提供できるようにする必要があります。

適切なスキャンエクスペリエンスを設計するために、アプリケーションに適用できる次のような可能性を検討してください。

* **スキャンエクスペリエンスがありません**
   * アプリケーションは、ガイド付きスキャンを使用しなくても完璧に機能します。自然なユーザー移動の過程で観察されたサーフェイスについて説明します。
   * たとえば、ユーザーが holographic spraypaint でサーフェイス上に描画できるようにするアプリケーションでは、ユーザーに現在表示されているサーフェイスのナレッジのみが必要です。
   * ユーザーが HoloLens を使用して既に多数の時間を費やしている場合、環境は既に完全にスキャンされている可能性があります。
   * ただし、空間マッピングによって使用されるカメラでは、ユーザーの前に 3.1 m しか表示されないことに注意してください。そのため、ユーザーが過去の距離を超えていない限り、空間マッピングは遠く離れたサーフェイスを認識しません。
   * スキャンされたサーフェイスをユーザーが理解できるように、アプリケーションはこの効果に対して視覚的なフィードバックを提供する必要があります。たとえば、仮想シャドウをスキャンしたサーフェイスにキャストすると、ユーザーがこれらのサーフェイスにホログラムを配置するのに役立ちます。
   * この場合、空間サーフェスオブザーバーの境界ボリュームは、各フレームを本文ロックされた[空間座標系](coordinate-systems.md)に更新して、ユーザーがフォローするようにする必要があります。

* **適切な場所の検索**
   * アプリケーションは、特定の要件を持つ場所で使用するように設計されている場合があります。
   * たとえば、アプリケーションでは、holographic kung-fu を安全に実行できるように、ユーザーの周囲に空の領域が必要になる場合があります。
   * アプリケーションでは、特定の要件をユーザーに事前に伝え、視覚的なフィードバックを明確にする必要があります。
   * この例では、アプリケーションは必要な空の領域の範囲を視覚化し、このゾーン内の不要なオブジェクトの存在を視覚的に強調表示する必要があります。
   * この場合、空間サーフェスのオブザーバーの境界ボリュームは、選択した場所でワールドロックの[空間座標系](coordinate-systems.md)を使用する必要があります。

* **サーフェイスの適切な構成を見つける**
   * アプリケーションでは、たとえば、2つの大規模なフラットな壁面の壁を作るために、特定のサーフェイスの構成が必要になる場合があります。
   * このような場合、アプリケーションでは、空間マッピングによって提供されるサーフェスを分析して適切なサーフェイスを検出し、ユーザーに対してユーザーに指示する必要があります。
   * アプリケーションのサーフェイス分析が完全に信頼できない場合は、フォールバックオプションが必要です。 たとえば、アプリケーションで入室がフラットな壁として誤って識別される場合、このエラーを修正するための簡単な方法が必要になります。

* **環境の一部をスキャンする**
   * アプリケーションでは、ユーザーの指示に従って、環境の一部のみをキャプチャすることをお勧めします。
   * たとえば、アプリケーションは部屋の一部をスキャンするので、ユーザーが販売する家具用に分類された holographic 広告を投稿することができます。
   * この場合、アプリケーションは、スキャン中にユーザーによって監視されているリージョン内の空間マッピングデータをキャプチャする必要があります。

* **部屋全体をスキャンする**
   * アプリケーションでは、ユーザーの背後にあるものも含め、現在の部屋にあるすべてのサーフェイスのスキャンが必要になる場合があります。
   * たとえば、ゲームでは、すべての方向から何百もの Lilliputians が発生した場合に、ユーザーを Gulliver のロールに配置することができます。
   * このような場合、アプリケーションは、現在の部屋に既にスキャンされているサーフェイスの数を判断し、大きなギャップを埋めるようにユーザーの宝石を誘導する必要があります。
   * このプロセスの重要なのは、まだスキャンされていないサーフェイスをユーザーに明確にするための視覚的なフィードバックを提供することです。 アプリケーションでは、[距離ベースのフォグ](https://msdn.microsoft.com/library/windows/desktop/bb173401%28v=vs.85%29.aspx)を使用して、空間マッピングサーフェイスでカバーされていない領域を視覚的に強調することができます。

* **環境の初期スナップショットを取得する**
   * アプリケーションでは、初期の "スナップショット" を取得した後、環境内のすべての変更を無視することができます。
   * これは、ユーザーが作成した、環境の初期状態と密接に結び付いているデータの中断を回避するために適している場合があります。
   * この場合、アプリケーションは、スキャンが完了したら、初期状態で空間マッピングデータのコピーを作成する必要があります。
   * 環境によってホログラムが正しく occluded されていない場合、アプリケーションは空間マッピングデータへの更新の受信を続行する必要があります。
   * 空間マッピングデータを継続的に更新することで、発生したすべての変更を視覚化することができ、環境の以前の状態と現在の状態の違いをユーザーに明確にすることができます。

* **環境のユーザーが開始したスナップショットを取得する**
   * アプリケーションでは、ユーザーによって指示された場合にのみ、環境の変更に応答する必要があります。
   * たとえば、ユーザーは、さまざまな瞬間にその場所をキャプチャすることにより、友人の複数の 3D ' statues ' を作成できます。

* **ユーザーが環境を変更できるようにする**
   * アプリケーションは、ユーザーの環境で行われた変更にリアルタイムで応答するように設計されている場合があります。
   * たとえば、curtain を描画したユーザーは、holographic play に対して "シーンの変更" をトリガーできます。

* **空間マッピングデータのエラーを回避するためのユーザーガイド**
   * アプリケーションでは、環境のスキャン中にユーザーにガイダンスを提供することができます。
   * これにより、ユーザーは、sunlit のウィンドウやミラーを離れるなどして、[空間マッピングデータ内](spatial-mapping-design.md#what-influences-spatial-mapping-quality)の特定の種類のエラーを回避できます。

注意すべきもう1つの詳細は、空間マッピングデータの "範囲" が無制限ではないことです。 空間マッピングでは、大きなスペースの永続的なデータベースが構築されますが、ユーザーの周囲のサイズが制限された ' バブル ' では、アプリケーションでそのデータを使用できるようになります。 したがって、長い corridor の先頭から開始して、開始から十分な距離が得られない場合は、最終的に空間サーフェスが先頭に戻ることになります。 もちろん、これらのサーフェイスは、使用可能な空間マッピングデータから消滅した後で、アプリケーションにキャッシュすることで軽減できます。

## <a name="mesh-processing"></a>メッシュ処理

これは、サーフェイス内の一般的なエラーの種類を検出し、必要に応じて空間マッピングデータをフィルター処理、削除、または変更するのに役立ちます。

空間マッピングデータは、実際のサーフェイスにできるだけ忠実として使用することを想定しているので、どのような処理を適用しても、画面が "真実" からさらに変化することに注意してください。

役に立つ可能性があるさまざまな種類のメッシュ処理の例を次に示します。

* **穴の塗りつぶし**
   * ダークマテリアルで作成された小さなオブジェクトがスキャンに失敗した場合、周囲のサーフェイスに穴が残されます。
   * 穴はオクルージョンに影響します。ホログラムは、不透明な現実世界の表面に穴を表示できます。
   * 穴は raycasts に影響します。ユーザーがサーフェイスを操作するために raycasts を使用している場合、これらの光線が穴を通過することは望ましくありません。 軽減策の1つは、適切にサイズ設定されたリージョンをカバーする複数の raycasts のバンドルを使用することです。 これにより、"外れ値" の結果をフィルター処理して、1つの raycast が小さな穴を通過した場合でも、集計結果が引き続き有効になるようにすることができます。 ただし、このアプローチには計算コストがかかることに注意してください。
   * 穴は物理的な衝突に影響します。物理シミュレーションによって制御されるオブジェクトは、床の穴を通過して失われる可能性があります。
   * Surface メッシュでは、このような穴をアルゴリズムに塗りつぶすことができます。 ただし、windows や doorways などの "実際のホール" が入力されないように、アルゴリズムを調整する必要があります。 ' 実際のホール ' を ' 虚数穴 ' から確実に区別することは困難であるため、' size ' や ' 境界図形 ' などのさまざまなヒューリスティックを試してみる必要があります。

* **Hallucination の削除**
   * 反射、明るいライト、およびオブジェクトの移動は、中程度の小さな残留物を維持することができます。
   * Hallucinations への影響の影響: Hallucinations は、他のホログラムの前に移動するダークシェイプとして表示されることがあります。
   * Hallucinations は raycasts に影響します。 raycasts を使用してユーザーがサーフェイスを操作できるようにする場合、これらの光線は、背後にある表面ではなく hallucination にヒットする可能性があります。 穴の場合と同様に、1つの raycast ではなく多くの raycasts を使用することができますが、この場合も計算コストが発生します。
   * Hallucinations は、物理的な衝突に影響を与えます。物理シミュレーションによって制御されるオブジェクトは、hallucination に対してスタックし、一見した領域の領域を移動できなくなる可能性があります。
   * Surface メッシュからこのような hallucinations をフィルター処理できます。 ただし、穴の場合と同様に、照明とドアハンドルなどの実際の小さなオブジェクトが削除されないように、アルゴリズムを調整する必要があります。

* **滑らかさ**
   * 空間マッピングは、実際の対応するものと比較して、粗いまたは "雑音" のように見える表面を返すことがあります。
   * 滑らかさは、物理的な衝突に影響します。フロアが粗い場合は、物理的にシミュレートされたゴルフボールが直線内でスムーズにロールすることはできません。
   * 滑らかさはレンダリングに影響します。表面が直接視覚化されている場合、表面法線の外観が影響を受けることがあり、' クリーン ' の外観が中断される可能性があります。 サーフェイスのレンダリングに使用されるシェーダー内の適切な光源とテクスチャを使用することによって、これを軽減することができます。
   * Surface メッシュでの粗さを滑らかにすることができます。 ただし、これにより、対応する実際のサーフェイスから離れた場所にサーフェイスがプッシュされる可能性があります。 近接性を維持することは、正確なホログラムオクルージョンを生成し、ユーザーが holographic サーフェイスとの正確で予測可能な相互作用を実現できるようにするために重要です。
   * コスメティックの変更のみが必要な場合は、頂点の位置を変更せずに頂点の法線を滑らかにするだけで十分な場合があります。

* **平面の検索**
   * アプリケーションでは、空間マッピングによって提供されるサーフェイスに対して実行する必要のあるさまざまな形式の分析があります。
   * 単純な例の1つは、"平面検索" です。サーフェイスの境界領域、主に平面領域を識別します。
   * 平面領域は、アプリケーションによって holographic コンテンツが自動的に配置される holographic のワークサーフェスとして使用できます。
   * 平面領域では、ユーザーインターフェイスを制限して、ユーザーがニーズに最も合ったサーフェイスと対話できるようにします。
   * 平面領域は、LCD 画面、テーブル、ホワイトボードなどの機能オブジェクトに対応する holographic のために、実際の世界のように使用できます。
   * 平面領域では、再生領域を定義して、videogame レベルの基礎を形成できます。
   * 平面領域を使用すると、仮想エージェントは、実際の人間が見ている可能性のあるフロアの領域を特定することで、実際の世界を移動できます。

## <a name="prototyping-and-debugging"></a>プロトタイプとデバッグ

### <a name="useful-tools"></a>便利なツール
* [Hololens エミュレーター](using-the-hololens-emulator.md)は、物理的な hololens にアクセスせずに空間マッピングを使用するアプリケーションを開発するために使用できます。 これにより、hololens でのライブセッションをリアルな環境でシミュレートし、アプリケーションが通常使用するすべてのデータ (HoloLens モーション、空間座標系、空間マッピングメッシュなど) を使用することができます。 これを使用すると、信頼性のある反復可能な入力を提供できます。これは、問題をデバッグし、コードの変更を評価するのに役立ちます。
* シナリオを再現するには、ライブ HoloLens からネットワーク経由で空間マッピングデータをキャプチャし、それをディスクに保存して、後続のデバッグセッションで再利用します。
* [Windows デバイスポータルの3d ビュー](using-the-windows-device-portal.md#3d-view)では、空間マッピングシステムを介して現在使用可能なすべての空間サーフェスを確認することができます。 これにより、アプリケーション内の空間サーフェスを比較する基準が提供されます。たとえば、不足しているか、間違った場所に表示されている空間サーフェスがあるかどうかを簡単に確認できます。

### <a name="general-prototyping-guidance"></a>プロトタイプの一般的なガイダンス
* 空間マッピングデータの[エラー](spatial-mapping-design.md#what-influences-spatial-mapping-quality)はユーザーのエクスペリエンスに大きな影響を与える可能性があるため、さまざまな環境でアプリケーションをテストすることをお勧めします。
* たとえば、机で同じ場所に常にテストするという習慣ではトラップされません。 さまざまな位置、形状、サイズ、およびマテリアルのさまざまなサーフェイスでテストを行うようにしてください。
* 同様に、統合または記録されたデータはデバッグに役立ちますが、同じ少数のテストケースには依存しないようにしてください。 これにより、より多様なテストが以前に検出された重要な問題を見つけることが遅れる可能性があります。
* 実際のユーザー (および理想的には coached ではありません) でテストを実行することをお勧めします。これは、ユーザーが HoloLens またはアプリケーションをまったく同じ方法で使用しない可能性があるためです。 実際には、異なるているユーザーの行動、知識、および前提条件はどのようになるかを驚かれるかもしれません。

## <a name="see-also"></a>関連項目
* [部屋のスキャンの可視化](room-scan-visualization.md)
* [立体音響の設計](spatial-sound-design.md)
* [Unity の永続化](persistence-in-unity.md)
